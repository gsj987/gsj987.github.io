<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=generator content="Hugo 0.68.3"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>homelab 搭建日志 | gsj987的博客</title><meta property="og:title" content="homelab 搭建日志 - gsj987的博客"><meta property="og:type" content="article"><meta property="article:published_time" content="2023-01-25T16:04:24+08:00"><meta property="article:modified_time" content="2023-01-25T16:04:24+08:00"><meta name=Keywords content="架构,python,前端,xamarin,软件工程,机器学习,机器视觉,c#,angular"><meta name=description content="homelab 搭建日志"><meta name=author content="gsj987"><meta property="og:url" content="https://gsj987.github.io/posts/build-homelab-log/"><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/css/normalize.css><link rel=stylesheet href=/css/prism.css><link rel=stylesheet href=/css/style.css><script type=text/javascript src=//cdn.bootcss.com/jquery/3.2.1/jquery.min.js></script></head><body><header id=header class=clearfix><div class=container><div class=col-group><div class=site-name><a id=logo href=https://gsj987.github.io/>gsj987的博客</a><p class=description>技术学习和创业思考</p></div><div><nav id=nav-menu class=clearfix><a href=https://gsj987.github.io/>首页</a>
<a href=https://gsj987.github.io/archives/ title=归档>归档</a>
<a href=https://gsj987.github.io/about/ title=关于>关于</a></nav></div></div></div></header><div id=body><div class=container><div class=col-group><div class=col-8 id=main><div class=res-cons><article class=post><header><h1 class=post-title>homelab 搭建日志</h1></header><date class="post-meta meta-date">2023年1月25日</date><div class=post-meta><span>|</span>
<span class=meta-category><a href=https://gsj987.github.io/categories/homelab>homelab</a></span></div><div class=post-content><p>最近搬新家，顺便把家庭网络和 homelab 的结构简单搭建了一下。</p><p>其实以前一直有用树莓派搭建简单的 self-hosted 服务，以及下载服务。但毕竟一个派的计算能力有限，arm 平台的应用也经常由于支持性问题，许多服务没有最好的选择。</p><p>在新家我有了更好的网络设施，也设了专门的信息箱，可以添加海量设备，正好把原有的服务有个整理和扩展。</p><p>就需求而言，我的 homelab 主要解决以下的几个问题：</p><ul><li>科学上网能力，国内工作者的刚需</li><li>私有服务的部署能力，不能把自己的一切都交给大公司</li><li>资料存储能力，家庭共享和保存古早资料是个好习惯</li><li>稳定的内网环境，方便倒腾各种玩意儿</li></ul><p>总体而言，我的网络结构如下图</p><p><img src=https://cdn.qiniu.gsj987.cn/blog/20230125/Untitled-2023-01-24-1137.png alt=Untitled-2023-01-24-1137.png></p><p>全屋wifi 覆盖我选择使用 TP Link 的全屋网络方案，上墙的 AP 用 POE 在墙内走线，在装修时就预埋进去，节省空间又能让所有房间都有充足的信号覆盖，同时保留了有线网口，在书房可以用有线连接桌面设备，提供更稳定的网络连接能力，玩嵌入式设备的时候一接网线就搞定。</p><p>POE Switch 是 TP Link 自带的 POE 路由器充当的。由于我在上层还有一个软路由，所以只拿他当交换机用，所有的口连接的都是 Lan。TP Link总控提供了4个lan口，套装里却只有3个AP，感觉上厂商在设计时已经考虑我这样的使用情况了。</p><p>软路由我选了 iKoolcore R1 ，倒也没有什么特殊的理由，就是在推上看到的广告，同时又是最新的 intel 架构，比友善之臂性能更好，应用面也更强，网口丰富（有3个lan，1个wan），价格也不贵，就顺下了。整体的体验还是蛮不错的，出厂已经预装了 PVE 和两个虚拟系统：OpenWRT和Debian，前者是目前功能最丰富的路由系统，后者是经典 linux 发行版跑 Docker 绝对稳定。x86的架构不用再像以前玩 arm，连个合适的 docker 镜像都下不到，自己编译还可能有问题。OpenWRT在出厂时已经装了不少应用，几乎是零折腾。</p><p>OpenWRT 的部署在 POE Switch 的 lan 上，这样才能和 AP 共享内网网段。TP Link 不知道如何在 wan 上设桥接，用 lan 一样完美解决问题（就是浪费一个 lan 口）。主要的点在于 AP 上设备的 DHCP 是由 Switch 提供的，而内网段上其他的服务，都是由 OpenWRT提供的。所以在 DHCP 的设置上，两个服务应提供不同的 IP 段避免冲突。</p><p>内网穿透方案我选了Tailscale，一个服务化的 wireguard ，看者网上的教程很容易就搭建完成。我家的手机和宽带都是电信，所以直接能建立连接不需要中转。之前也折腾过 wireguard ,但复杂的配置方式，以及做内网穿透需要一个中转服务器的做法，令人劝退。Tailscale的服务化配置，零折腾的让我构建好组网，经过测试，这样的组网方式没有中转，唯一的缺点是 Tailscale 的免费方案有设备上限，但对个人用户来说已经足够。</p><p>另一方面，ios上要连接tailscale需要有专门的客户端，启动方式也是调用系统的 api 创建一个 vpn 连接，这会和手机上的科学上网产生冲突。我原先手机是用 Surge 科学上网的，他的收费版也支持 wireguard 协议，但不支持 tailscale。还好另一款移动端翻墙应用 Choc 支持 tailscale，可以在 ios 上同时开启科学上网和内网访问，因此我也全面把手机端的翻墙应用换成了 Choc，目前实用感觉还可以。</p><p>回到内网，在openWRT 中，我使用Openclash 用来科学上网，具体的使用方法和移动端 clash 差不多，可以导入机场的服务器配置。在内网手机中，我通过对 Surge 或 Choc 做额外规则，让网络连接到家庭网络时，自动全部使用直接连接，这样不会让 openclash 和移动端的 Surge 重复代理，在家里有科学上网路由器的情况下没必要。</p><p>另外，内网中各服务还是需要分配域名，同时如果要在移动端使用这些服务，比如我使用 webdav 或 caldav 在 ios 上共享日历和文件，必须配置域名和SSL。我使用 let’s encrypt 自动定期更新免费的 ssl ，并分配域名 htts://*.local.gsj987.cn 给所有内网服务，在DNS上全配置成内网域名。由于我的域名托管在阿里云上，可以通过自动化脚本配置域名解析规则更新ssl证书。另由于我的服务都是通过tailscale进行的访问，所以在公网上也可以直接解析成内网网址，都可以访问到，也解决了安全问题。</p><p>在网络出口处，我还是用了运营商的光猫来接入网络，多占了一个设备，所有的网络出口瓶颈就全在这个光猫上了。有些别的玩家会使用猫棒来增加出口的流量。这个可以是未来可以继续探索优化的方案。</p><p>Pi 和移动硬盘都是旧设备，所以本着废物利用，不买就是赚的原则，没有用 NAS 作为存储，而是用 Pi + 移动硬盘组建了一个 NFS 作为存储，总的来说工作还算顺利，但就数据安全而言，用 NAS 做个 Raid 才是完全方案，也是值得下一步探索。</p><p>以上就是我初步的 homelab 方案，后续我会在这个基础上逐步把方案优化，包括上述的猫棒和NAS，以及更好的内网路由和虚拟化方案，方便做快速的实验。期待和读者交流。</p></div><div class=post-archive><h2>See Also</h2><ul class=listing><li><a href=/posts/take-note-with-denote/>take note with denote.el</a></li><li><a href=/posts/publish-blog-from-ios/>在iOS上发布GitHub pages 文章</a></li><li><a href=/posts/webassembly-in-wechat/>在微信小程序中使用 WebAssembly 调用 OpenCV</a></li><li><a href=/posts/how-to-take-smart-notes-7/>聪明的笔记6 - 分享观点 / 形成习惯 / 后记</a></li><li><a href=/posts/how-to-take-smart-notes-6/>聪明的笔记6 - 构建想法</a></li></ul></div><div class="post-meta meta-tags"><ul class=clearfix><li><a href=https://gsj987.github.io/tags/homelab>homelab</a></li></ul></div></article><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"gsj987s-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><div id=secondary><section class=widget><form id=search action=//www.google.com/search method=get accept-charset=utf-8 target=_blank _lpchecked=1><input type=text name=q maxlength=20 placeholder=Search>
<input type=hidden name=sitesearch value=https://gsj987.github.io/>
<button type=submit class="submit icon-search"></button></form></section><section class=widget><h3 class=widget-title>最近文章</h3><ul class=widget-list><li><a href=https://gsj987.github.io/posts/build-homelab-log/ title="homelab 搭建日志">homelab 搭建日志</a></li><li><a href=https://gsj987.github.io/posts/take-note-with-denote/ title="take note with denote.el">take note with denote.el</a></li><li><a href=https://gsj987.github.io/posts/publish-blog-from-ios/ title="在iOS上发布GitHub pages 文章">在iOS上发布GitHub pages 文章</a></li><li><a href=https://gsj987.github.io/posts/webassembly-in-wechat/ title="在微信小程序中使用 WebAssembly 调用 OpenCV">在微信小程序中使用 WebAssembly 调用 OpenCV</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-7/ title="聪明的笔记6 - 分享观点 / 形成习惯 / 后记">聪明的笔记6 - 分享观点 / 形成习惯 / 后记</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-6/ title="聪明的笔记6 - 构建想法">聪明的笔记6 - 构建想法</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-5/ title="聪明的笔记5 - 记聪明的笔记">聪明的笔记5 - 记聪明的笔记</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-4/ title="聪明的笔记4 - 为了理解而阅读">聪明的笔记4 - 为了理解而阅读</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-3/ title="聪明的笔记3 - ﻿分离和连接任务">聪明的笔记3 - ﻿分离和连接任务</a></li><li><a href=https://gsj987.github.io/posts/how-to-take-smart-notes-2/ title="聪明的笔记2 - 四个重要原则">聪明的笔记2 - 四个重要原则</a></li></ul></section><section class=widget><h3 class=widget-title>分类</h3><ul class=widget-list><li><a href=https://gsj987.github.io/categories/emacs/>emacs(2)</a></li><li><a href=https://gsj987.github.io/categories/homelab/>homelab(1)</a></li><li><a href=https://gsj987.github.io/categories/linux/>linux(1)</a></li><li><a href=https://gsj987.github.io/categories/machine-learning/>machine-learning(5)</a></li><li><a href=https://gsj987.github.io/categories/opencv/>opencv(1)</a></li><li><a href=https://gsj987.github.io/categories/reading-notes/>reading-notes(7)</a></li><li><a href=https://gsj987.github.io/categories/software-engineering/>software-engineering(1)</a></li><li><a href=https://gsj987.github.io/categories/workflow/>workflow(1)</a></li></ul></section><section class=widget><h3 class=widget-title>标签</h3><div class=tagcloud><a href=https://gsj987.github.io/tags/android/>android</a>
<a href=https://gsj987.github.io/tags/architecture/>architecture</a>
<a href=https://gsj987.github.io/tags/cnn/>cnn</a>
<a href=https://gsj987.github.io/tags/ddd/>ddd</a>
<a href=https://gsj987.github.io/tags/elisp/>elisp</a>
<a href=https://gsj987.github.io/tags/emacs/>emacs</a>
<a href=https://gsj987.github.io/tags/graphql/>graphql</a>
<a href=https://gsj987.github.io/tags/homelab/>homelab</a>
<a href=https://gsj987.github.io/tags/how-to-take-smart-notes/>how-to-take-smart-notes</a>
<a href=https://gsj987.github.io/tags/opencv/>opencv</a>
<a href=https://gsj987.github.io/tags/raspberry-pi/>raspberry-pi</a>
<a href=https://gsj987.github.io/tags/study-method/>study-method</a>
<a href=https://gsj987.github.io/tags/tensorflow/>tensorflow</a>
<a href=https://gsj987.github.io/tags/wechat/>wechat</a>
<a href=https://gsj987.github.io/tags/windows/>windows</a></div></section><section class=widget><h3 class=widget-title>其它</h3><ul class=widget-list><li><a href=https://gsj987.github.io/index.xml>文章 RSS</a></li></ul></section></div></div></div></div><footer id=footer><div class=container>&copy; 2023 <a href=https://gsj987.github.io/>gsj987的博客 By gsj987</a>.
Powered by <a rel="nofollow noreferer noopener" href=https://gohugo.io target=_blank>Hugo</a>.
<a href=https://www.flysnow.org/ target=_blank>Theme</a> based on <a href=https://github.com/rujews/maupassant-hugo target=_blank>maupassant</a>.</div></footer><script type=text/javascript>(function(){$("pre code").parent().addClass("line-numbers")}())
window.MathJax={tex2jax:{inlineMath:[['$','$']],processEscapes:true}};</script><script type=text/javascript src=/js/prism.js async></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script><a id=rocket href=#top></a><script type=text/javascript src="/js/totop.js?v=0.0.0" async></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-59884936-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>